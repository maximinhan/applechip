final String DEFAULT_PROFILE = 'development'
buildscript {
    repositories {
        maven { url "http://nexus.bywook.com/content/groups/public" }
        mavenCentral()
        jcenter()
        maven { url "http://download.java.net/maven/2" }
        maven { url "http://repo.springsource.org/plugins-release" }
	}
	dependencies {
		classpath("org.gradle.api.plugins:gradle-tomcat-plugin:0.9.8")
		classpath("org.springframework.build.gradle:propdeps-plugin:0.0.7")
	}
}

ext {
	linkHomepage = 'http://applechip.bywook.com'
	linkCi = 'https://jenkins.bywook.com'
	linkIssue = 'https://redmine.bywook.com'
	linkScmUrl = 'https://github.com/maximinhan/applechip'
	linkScmConnection = 'scm:git:git://github.com/maximinhan/applechip.git'
	linkScmDevConnection = 'scm:git:ssh://git@github.com:maximinhan/applechip.git'

	moduleProjects  = subprojects.findAll {
		it.name.equals('applechip-core') || it.name.equals('applechip-plugin')
	}
	webProjects  = subprojects.findAll {
		it.name.equals('applechip-api') || it.name.equals('applechip-web')
	}
	appProjects  = subprojects.findAll {
		it.name.equals('applechip-android')
	}
}

gradle.taskGraph.beforeTask {Task task -> println "excuting $task ..."}
gradle.taskGraph.afterTask {Task task, TaskState state -> if (state.failure) { println "Failure" } else { println "Done" }}

configure(rootProject) {
	tasks.withType(JavaCompile){
		def warnLogFile = file("$buildDir/${name}Warnings.log")
		logging.addStandardErrorListener(new StandardOutputListener(){ void onOutput(CharSequence output){ warnLogFile << output }})
	}
	task wrapper(type: Wrapper) {
	  gradleVersion = "2.0"
	}
}

configure(allprojects) { project ->
	repositories {
		maven { url "http://nexus.bywook.com/content/groups/public" }
		mavenCentral()
	}
    apply plugin: 'java'
	apply plugin: 'eclipse'
	apply plugin: 'propdeps'
	apply plugin: 'propdeps-eclipse'
	//apply plugin: 'propdeps-maven'
	//apply plugin: 'propdeps-idea'
    //apply plugin: 'idea'
	
	group = "com.applechip"
	
	ext.gradleScriptDir = "${rootProject.projectDir}/gradle"
    apply from: "${gradleScriptDir}/gradleScript.gradle"
	
	//system
	ext.javaVersion = "1.7"
    ext.javaEncoding = "UTF-8"
    
    //sourceCompatibility = 1.8
    //targetCompatibility = 1.8
    [compileJava, compileTestJava]*.options*.encoding = "${javaEncoding}"
    
    //properties
    ext.jdbcDrivers = [ "mysql:mysql-connector-java:5.1.31", "com.microsoft.sqlserver:sqljdbc4:4.0", "com.oracle:ojdbc7:12.1.0.2", "org.hsqldb:hsqldb:2.3.2", "com.h2database:h2:1.4.181" ] 
	ext.jdbcName = String.format("%s_%s", rootProject.name, "${version}".replaceAll("\\.", "_").replaceAll("\\-", "_")).toUpperCase()
	ext.jdbcUrl = String.format("${jdbcUrl}", "${jdbcName}")

	//dependencies
	ext.springframeworkVersion = '4.0.6.RELEASE'
    ext.springframeworkDataVersion = '1.8.0.RELEASE'
    ext.springframeworkSecurityVersion = '3.2.5.RELEASE'
    ext.hibernateVersion = '4.3.5.Final'
    ext.slf4jVersion = '1.7.7'
    ext.queryDslVersion = '3.4.3'
}

configure(webProjects) {
    apply plugin: 'war'
    apply plugin: 'eclipse-wtp'
    apply from: createVersionTextTask
    dependencies {
		compile project(':applechip-core')
    	providedCompile 'javax.servlet:javax.servlet-api:3.1.0'
    	providedCompile 'javax.servlet:jstl:1.2'
		provided jdbcDrivers
	    provided("org.springframework.security:spring-security-core:${springframeworkSecurityVersion}")
		provided("org.springframework.data:spring-data-commons:${springframeworkDataVersion}")
		provided("org.springframework:spring-orm:$springframeworkVersion")
		provided("org.springframework:spring-tx:$springframeworkVersion")
		//provided("org.springframework:spring-jdbc:$springframeworkVersion")
		provided("org.springframework:spring-context-support:$springframeworkVersion")
		provided("org.springframework:spring-context:$springframeworkVersion")
		provided("org.springframework:spring-expression:$springframeworkVersion")
		provided("org.hibernate:hibernate-entitymanager:$hibernateVersion")
		provided("com.fasterxml.jackson.core:jackson-databind:2.4.1")
	    provided("com.fasterxml.jackson.core:jackson-annotations:2.4.1")
	    provided("com.fasterxml.jackson.core:jackson-core:2.4.1")
		//provided("org.hibernate:hibernate-core:$hibernateVersion")
		//provided("net.sf.ehcache:ehcache:2.8.3")
		provided("org.springframework:spring-webmvc:$springframeworkVersion")
		provided("org.springframework:spring-web:$springframeworkVersion")
		provided("org.springframework:spring-beans:$springframeworkVersion")
		provided("org.springframework:spring-core:$springframeworkVersion")
		provided("org.springframework:spring-aop:$springframeworkVersion")
		//provided("aopalliance:aopalliance:1.0")
		//provided("edu.uci.ics:crawler4j:3.5")
	    //provided("com.fasterxml.jackson.core:jackson-databind:2.4.1")
	    //provided("com.fasterxml.jackson.core:jackson-annotations:2.4.1")
	    //provided("com.mysema.querydsl:querydsl-jpa:3.4.0")
	    //provided("org.hibernate.javax.persistence:hibernate-jpa-2.1-api:1.0.0.Final")
    }
    configurations.all {
	    transitive = false
	}
    war {
    /*
    	manifest = osgiManifest { 
			instruction 'Private-Package', 'com.applechip' 
			instruction 'Bundle-Classpath', 'WEB-INF/classes' 
			instruction 'Import-Package', '''groovy.''' 
			instruction 'Created-By', 'yyy' 
			instruction 'Bundle Description', "${project.description}" 
			vendor = "yyy" 
			symbolicName = "${project.group}" + "-" + "${project.name}" 
			version = strippedVersion() 
			classesDir = new File( "${buildDir}/classes" ) 
			classpath = configurations.runtime 
			instruction 'Web-ContextPath', "${name}"
		}
		*/
    	dependsOn createVersionText
    	from(buildDir) {
    		include 'version.txt'
    		into('WEB-INF/classes')
    	}
    }
}

configure(subprojects) { project ->
    apply from: uploadArchivesTask
	dependencies {
		provided("org.projectlombok:lombok:1.14.4")
		provided("commons-configuration:commons-configuration:1.10")
		provided("commons-lang:commons-lang:2.6")
		provided("commons-io:commons-io:2.4")
		provided("commons-collections:commons-collections:3.2.1")
		provided("commons-dbcp:commons-dbcp:1.4")
		provided("commons-codec:commons-codec:1.9")
		provided("commons-pool:commons-pool:1.6")
		provided("org.slf4j:jcl-over-slf4j:${slf4jVersion}")
	    provided("org.slf4j:slf4j-api:${slf4jVersion}")
	    provided("ch.qos.logback:logback-core:1.1.2")
	    provided("ch.qos.logback:logback-classic:1.1.2")
		testCompile("org.springframework:spring-test:${springframeworkVersion}")
		testCompile("junit:junit:4.11")
		testCompile("org.mockito:mockito-all:1.9.5")
	}
	
    sourceSets {
		main {
			output.classesDir = 'build/classes'
			output.resourcesDir = 'build/classes'
		}
		test {
			output.classesDir = 'build/test-classes'
			output.resourcesDir = 'build/test-classes'
		}
	}
	eclipse {
		classpath {
			defaultOutputDir = file('build/classes')
			file {
			    beforeMerged { classpath -> 
			        classpath.entries.clear()
			    }
				whenMerged { cp ->
					cp.entries.findAll { it instanceof org.gradle.plugins.ide.eclipse.model.SourceFolder  && it.path.startsWith("src/main/") }*.output = "build/classes" 
			        cp.entries.findAll { it instanceof org.gradle.plugins.ide.eclipse.model.SourceFolder  && it.path.startsWith("src/test/") }*.output = "build/test-classes" 
			        cp.entries.removeAll { it.kind == "output" }
				}
			}
		}
	}
	
	[processResources, processTestResources]*.filter(org.apache.tools.ant.filters.ReplaceTokens,
		tokens: [
			'jdbcType': project.properties['jdbcType'],
			'jdbcUrl': project.properties['jdbcUrl'],
			'jdbcUsername': project.properties['jdbcUsername'],
			'jdbcPassword': project.properties['jdbcPassword']
		]
	)
	processResources {
		//from('src/main/java') {
		//	excluded '**/*.java'
		//}
		into 'build/classes'
		includeEmptyDirs = true
	}
	
	processTestResources {
		//from('src/test/java') {
		//	excluded '**/*.java'
		//}
		into 'build/test-classes'
		includeEmptyDirs = true
	}
}

project(":applechip-core") {
	description = "Applechip Core"
	apply from: generateSchemaTask
	apply from: generateQueryDSLTask
	apply from: generateWsdlTask
	apply from: settingPropertiesTask
	dependencies {
		provided("org.springframework.security:spring-security-core:$springframeworkSecurityVersion")
		provided("org.springframework.data:spring-data-commons:${springframeworkDataVersion}")
		provided("org.springframework:spring-orm:$springframeworkVersion")
		provided("org.springframework:spring-tx:$springframeworkVersion")
		provided("org.springframework:spring-jdbc:$springframeworkVersion")
		provided("org.springframework:spring-context-support:$springframeworkVersion")
		provided("org.springframework:spring-context:$springframeworkVersion")
		provided("org.hibernate:hibernate-entitymanager:$hibernateVersion")
		provided("org.hibernate:hibernate-core:$hibernateVersion")
		provided("org.hibernate:hibernate-ehcache:$hibernateVersion")
		provided("org.hibernate.common:hibernate-commons-annotations:4.0.5.Final")
		provided("org.jboss.logging:jboss-logging:3.1.4.GA")
		provided("org.jboss:jandex:1.2.1.Final")
		provided("net.sf.ehcache:ehcache:2.8.3")
		provided("org.springframework:spring-webmvc:$springframeworkVersion")
		provided("org.springframework:spring-web:$springframeworkVersion")
		provided("org.springframework:spring-beans:$springframeworkVersion")
		provided("org.springframework:spring-core:$springframeworkVersion")
		provided("org.springframework:spring-aop:$springframeworkVersion")
		provided("org.springframework:spring-expression:$springframeworkVersion")
		provided("aopalliance:aopalliance:1.0")
		provided jdbcDrivers
		provided("edu.uci.ics:crawler4j:3.5")
	    provided("com.fasterxml.jackson.core:jackson-databind:2.4.1")
	    provided("com.fasterxml.jackson.core:jackson-annotations:2.4.1")
	    provided("com.fasterxml.jackson.core:jackson-core:2.4.1")
	    provided("org.eclipse.persistence:javax.persistence:2.1.0")
	    provided("org.aspectj:aspectjrt:1.8.1")
	    provided("org.aspectj:aspectjweaver:1.8.1")
    	provided 'javax.servlet:javax.servlet-api:3.1.0'
    	provided 'javax.servlet:jstl:1.2'
        provided("javax.ws.rs:jsr311-api:1.1.1")
        provided("javax.transaction:javax.transaction-api:1.2")
        provided("org.javassist:javassist:3.18.2-GA")
        provided("dom4j:dom4j:1.6")
	    provided("com.maxmind.geoip2:geoip2:0.9.0")
	    provided("org.hibernate:hibernate-envers:$hibernateVersion")
	    provided("commons-net:commons-net:3.3")
	}
	processResources {
		dependsOn settingProperties
	}
	compileJava {
	    dependsOn generateQueryDSL
	    source generateQueryDSL.destinationDir
	}
	
	compileGeneratedJava {
	    dependsOn generateQueryDSL
	    options.warnings = false
	    classpath += sourceSets.main.runtimeClasspath
	}
	clean {
	    delete sourceSets.generated.java.srcDirs
	}
	jar {
		println 'ssssssssssssssssssssssssssssss' + jdbcDriver
		dependsOn generateSchema
	}
}


project(":applechip-plugin") {
	description = "Applechip Plugin"
	dependencies {
	    compile gradleApi()
	    compile localGroovy()
	    compile("org.hibernate:hibernate-core:$hibernateVersion")
	}
	configurations.archives.artifacts.clear()
}
